angular.module("TreeView",[]).provider("treeViewConfig",function(){var e=this;this.options={iconLeaf:"fa fa-file glyphicon glyphicon-file",iconExpand:"fa fa-minus glyphicon glyphicon-minus",iconCollapse:"fa fa-plus glyphicon glyphicon-plus",template:['<ul class="tree-view-group">','<li ng-repeat="data in data[children]"','ng-class="{expanded: isExpanded(data)}"','ng-if="!filterModel || isFiltered(data)">','<span class="tree-icon" ng-class="getExpandIcon(data)"','ng-click="toggleExpanded(data, $event)"></span>','<a ng-class="{checked: isChecked(data), indetermine: !isChecked(data) && childrenChecked(data)}"','ng-click="toggleChecked(data, $event)">',"<tree-view-transclude></tree-view-transclude>","</a>","<tree-view-item",'ng-if="data[children] && isExpanded(data)"',"></tree-view-item>","</li>","</ul>"].join(" ")},this.$get=function(){return e.options}}).factory("treeViewService",function(){return{uniqueId:0,applyChanges:function(e,t,i){"addNewItem"===t&&this.transformDataToTree(i,e.$treeView.hashObject,e.$treeView.valueProperty,e.$treeView.childrenProperty)},transformDataToTree:function(e,t,i,n){angular.isArray(e)||(e=[e]);for(var r=[],a=0;a<e.length;a++)r.push(e[a]);for(;r.length;){var c=r.pop();if(c.$treeView=c.$treeView||{},i in c||(c[i]=this.uniqueId++),this.currentLength++,t[c[i]]=c,c[n]&&c[n].length)for(a=0;a<c[n].length;a++){var o=c[n][a];o.$treeView=o.$treeView||{},o.$treeView.parentData=c,r.push(o)}}return t}}}).directive("treeViewItem",function(){return{require:"^treeView",link:function(e,t,i,n){n.template(e,function(e){t.empty().append(e)})}}}).directive("treeViewTransclude",function(){return{link:function(e,t){e.transcludeScope=e.parentScopeOfTree.$new(),e.transcludeScope.node=e.data,e.transcludeScope.$index=e.$index,e.transcludeScope.$first=e.$first,e.transcludeScope.$middle=e.$middle,e.transcludeScope.$last=e.$last,e.transcludeScope.$odd=e.$odd,e.transcludeScope.$even=e.$even,e.$on("$destroy",function(){e.transcludeScope.$destroy()}),e.$treeTransclude(e.transcludeScope,function(e){t.empty().append(e)})}}}).directive("treeView",["treeViewConfig","treeViewService",function(e,t){return{scope:{outputAllInfo:"=",datas:"=inputModel",ngModel:"=",filterModel:"=",recursionCheck:"=",outputDuplicate:"=",singleMode:"=",options:"=",hashObject:"=",enableCheck:"="},transclude:!0,link:function(e,t,i,n,r){n.template(e,function(e){t.empty().append(e)}),e.$treeTransclude=r},controller:["$scope","$element","$attrs","$compile",function(i,n,r,a){i.parentScopeOfTree=i.$parent,i.options=i.options||{},i.displayProperty=i.options.displayProperty||"text",i.valueProperty=i.options.valueProperty||"id",i.children=i.options.childrenProperty||"children",i.iconLeaf=i.options.iconLeaf||e.iconLeaf,i.iconExpand=i.options.iconExpand||e.iconExpand,i.iconCollapse=i.options.iconCollapse||e.iconCollapse,i.iconCheck=i.options.iconCheck||e.iconCheck,i.iconUnCheck=i.options.iconUnCheck||e.iconUnCheck,this.template=a(e.template);var c={arrayMinus:function(e,t){e=e||[],t=t||[];for(var i=[],n=0;n<e.length;n++)-1===this.find(t,e[n])&&i.push(e[n]);return i},find:function(e,t){if(angular.isObject(t)){for(var n=0;n<e.length;n++)if(t[i.valueProperty]===e[n][i.valueProperty])return n;return-1}return e.indexOf(t)},shallowMinus:function(e,t){for(var i=0;i<e.length;i++)-1!==t.indexOf(e[i])&&(e.splice(i,1),i--)}},o={modelInited:!1,inited:!1,init:function(e){n.addClass("tree-view"),e.$treeView={hashObject:this.hashObject,valueProperty:i.valueProperty,childrenProperty:i.children},this.transformDataToTree(e),i.data={},i.data[i.children]=e,this.inited||this.bindEvents(),this.inited=!0,this.modelInited=!1},unwrap:function(e){for(var t=0;t<e.length;t++)e[t]=e[t][i.valueProperty]},updateModelByCheck:function(e,t,n){i.outputAllInfo||this.unwrap(e),t===!0?(i.ngModel=i.ngModel||[],Array.prototype.push.apply(i.ngModel,e)):c.shallowMinus(i.ngModel,e),i.outputDuplicate||(t===!0&&this.deleteDuplicated(i.ngModel),t===!1&&this.fillResult(i.ngModel,e,n))},fillResult:function(e,t,n){for(var r=[],a=n;a.$treeView.parentData;){var c=this.getParentItem(a);if(-1===t.indexOf(c))break;r.push(a),a=a.$treeView.parentData}if(r.length)for(var o=0;o<r.length;o++){var l=[].concat(r[o].$treeView.parentData[i.children]);l.splice(l.indexOf(r[o]),1),i.outputAllInfo||this.unwrap(l),Array.prototype.push.apply(e,l)}},deleteDuplicated:function(e){for(var t=[],n=0;n<e.length;n++){var r;i.outputAllInfo?r=e[n].$treeView.parentData:(r=this.hashObject[e[n]].$treeView.parentData,r=r&&r[i.valueProperty]),-1!==e.concat(t).indexOf(r)&&(t=t.concat(e.splice(n,1)),n--)}},updateStateByModelChange:function(e,t){var n;n=this.modelInited?c.arrayMinus(e,t):e||[];for(var r=c.arrayMinus(t,e),a=0;a<n.length;a++){var o=i.outputAllInfo?n[a]:this.hashObject[n[a]];o.$treeView.isChecked=!0,this.expandUp(o),this.modelInited||i.outputDuplicate||this.calculateDown(o)}for(a=0;a<r.length;a++)o=i.outputAllInfo?r[a]:this.hashObject[r[a]],!i.outputDuplicate&&o.$treeView.parentData&&o.$treeView.parentData.$treeView.isChecked||(o.$treeView.isChecked=!1,i.outputDuplicate||e.length&&(1!==r.length||n.length)||this.calculateDown(o));i.outputDuplicate||e.length!==this.currentLength||this.deleteDuplicated(i.ngModel),this.modelInited=!0},expandUp:function(e){var t=e.$treeView.parentData;t&&!t.$treeView.isExpanded&&(t.$treeView.isChecked?this.expandUp(t):(t.$treeView.isExpanded=!0,this.expandUp(t)))},getParentItem:function(e){var t,n=angular.isObject(e)?e:this.hashObject[e];return i.outputAllInfo?t=e.$treeView.parentData:(t=n.$treeView.parentData,t=t&&t[i.valueProperty]),t},calculateChecked:function(e,t){this.calculateDown(e,t),this.calculateUp(e,t)},calculateDown:function(e,t){if(e[i.children])for(var n=0;n<e[i.children].length;n++)e[i.children][n].$treeView.isChecked!==e.$treeView.isChecked&&(t&&t.push(e[i.children][n]),e[i.children][n].$treeView.isChecked=e.$treeView.isChecked,this.calculateDown(e[i.children][n],t))},calculateUp:function(e,t){if(e.$treeView.parentData&&e.$treeView.parentData.$treeView.isChecked!==e.$treeView.isChecked){for(var n=!!e.$treeView.parentData.$treeView.isChecked,r=0,a=0;a<e.$treeView.parentData[i.children].length;a++)e.$treeView.parentData[i.children][a].$treeView.isChecked&&r++;e.$treeView.parentData.$treeView.isChecked=r===a,e.$treeView.parentData.$treeView.isChecked!==n&&(t&&t.push(e.$treeView.parentData),this.calculateUp(e.$treeView.parentData))}},hashObject:{},currentLength:0,transformDataToTree:function(e){t.transformDataToTree(e,this.hashObject,i.valueProperty,i.children),r.hashObject&&(i.hashObject=this.hashObject)},bindEvents:function(){var e=this;i.singleMode?i.$watch("ngModel",function(t,i){e.updateStateByModelChange(t,i)}):i.$watchCollection("ngModel",function(t,i){t=t||[],i=i||[],e.updateStateByModelChange(t,i)}),i.$watch("filterModel",function(t,n){if(t){var r=[];angular.forEach(e.hashObject,function(e,n){t=t.toLowerCase();var a=e[i.displayProperty].toString().toLowerCase();-1!==a.indexOf(t)?r.push(e):e.$treeView.isFiltered=!1});for(var a=0;a<r.length;a++)r[a].$treeView.isFiltered=!0,r[a].$treeView&&r[a].$treeView.parentData&&(r[a].$treeView.parentData.$treeView.isFiltered=!0),e.filtUp(r[a]),e.expandUp(r[a])}})},filtUp:function(e){e.$treeView.parentData&&!e.$treeView.parentData.isFiltered&&(e.$treeView.parentData.isFiltered=!0,e.$treeView.parentData.$treeView.isFiltered=!0,this.filtUp(e.$treeView.parentData))}};i.getExpandIcon=function(e){return e[i.children]&&e[i.children].length?e.$treeView.isExpanded?i.iconExpand:i.iconCollapse:i.iconLeaf},i.toggleExpanded=function(e,t){e.$treeView.isExpanded=!e.$treeView.isExpanded,t.stopPropagation()},i.isExpanded=function(e){return!(!e.$treeView||!e.$treeView.isExpanded)},i.isChecked=function(e){return!(!e.$treeView||!e.$treeView.isChecked)},i.childrenChecked=function(e){if(!e[i.children]||!e[i.children].length)return!1;for(var t=[],n=e[i.children],r=0;r<n.length;r++)t.push(n[r]);for(;t.length;){var a=t.pop();if(a.$treeView.isChecked)return!0;if(a.children&&a.children.length)for(r=0;r<a.children.length;r++)t.push(a.children[r])}return!1},i.toggleChecked=function(e){var t=i.isChecked(e),n=[e];i.singleMode&&o.initCheck(),e.$treeView.isChecked=!t,i.recursionCheck&&o.calculateChecked(e,n),o.updateModelByCheck(n,e.$treeView.isChecked,e)},i.isFiltered=function(e){return!!e.$treeView.isFiltered},i.isCheckable=function(){return i.enableCheck!==!1},i.$watch("datas",function(e,t){angular.isDefined(e)&&o.init(e)})}]}}]);